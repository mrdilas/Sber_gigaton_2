from gigachat import GigaChat

API_TOKEN = 'MDE5OTlhYjktYzA5My03ZjQzLTk1OTMtMzI5NzVmYTA0OWMyOjJlYjNkOWYxLWFmMTYtNGRlMy04ODQ2LWY2MTk0OWU4ODhjZQ=='

class File:
    def __init__(self, index: int, id: str, fullname: str):
        self.index = index
        self.id = id
        self.fullname = fullname

    def __repr__(self):
        return f"File(index={self.index}, id='{self.id}', fullname='{self.fullname}')"

class GigaChatManager:
    def __init__(self, api_token: str):
        self.giga = GigaChat(
            credentials=api_token,
            verify_ssl_certs=False,
        )
        self._files_cache = None

    def _get_files_data(self):
        if self._files_cache is None:
            self._files_cache = self.giga.get_files()
        return self._files_cache

    @property
    def files(self) -> list[File]:
        return [
            File(index, data.id_, data.filename)
            for index, data in enumerate(self._get_files_data().data)
        ]

    def delete_all_files(self):
        print("üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ GigaChat...")
        files_count = len(self.files)
        for i, file in enumerate(self.files, 1):
            print(f"–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ {i}/{files_count}: {file.fullname}")
            self.giga.delete_file(file.id)
        self._files_cache = None
        print("‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã")

    def delete_file_by_id(self, file_id: str):
        self.giga.delete_file(file_id)
        self._files_cache = None

    def get_balance(self):
        table_data = []
        for balance_item in self.giga.get_balance().balance:
            table_data.append([balance_item.usage, f"{balance_item.value:,.0f}"])
        print("–ë–∞–ª–∞–Ω—Å:")
        return table_data
    
    def upload_file(self, file_path: str):
        print(f"üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ GigaChat: {file_path}")
        
        with open(file_path, "rb") as file:
            self.giga.upload_file(file)
        self._files_cache = None
        print(f"‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ GigaChat")

    def ask_according_to_material(self, message: str, material_id: str):
        prompt = f"""–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –≤ —Å—Ñ–µ—Ä–µ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏—Ö –ø—Ä–∞–≤ –∏ —Å–≤–æ–±–æ–¥, "
                    "–∞ —Ç–∞–∫–∂–µ —Ö–æ—Ä–æ—à–æ –∑–Ω–∞–∫–æ–º—ã –∑–∞–∫–æ–Ω—ã, –∫–æ–¥–µ–∫—Å—ã –∏ –ø–æ–¥–∑–∞–∫–æ–Ω–Ω—ã–µ –∞–∫—Ç—ã –†–§. –¢–µ–±–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞"
                    "–≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö, –¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –†–§. –í–æ—Ç –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
                     + {message} + "."
                     "–û—Ç–≤–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞–º–º–æ—Ç–Ω–æ, –∞ —Ç–∞–∫–∂–µ —É–∫–∞–∑–∞—Ç—å –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞, –Ω–∞ –∫–∞–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö (–∑–∞–∫–æ–Ω–∞—Ö)"
                     "–†–§ –æ—Å–Ω–æ–≤–∞–Ω –æ—Ç–≤–µ—Ç/–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è.

–û—Ç–≤–µ—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –≥—Ä–∞–º–æ—Ç–Ω–æ –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
## –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É
–ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–ø–∏—Å–∞–Ω–∞ –≤–∞—à–∞ —Å–∏—Ç—É–∞—Ü–∏—è, –≥—Ä–∞–º–æ—Ç–Ω–æ —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è
–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞
### –ó–∞–∫–æ–Ω—ã, —è–≤–ª—è—é—â–∏–µ—Å—è –æ—Å–Ω–æ–≤–∞–Ω–∏—è–º–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
1. K1-—ã–π –∫–æ–¥–µ–∫—Å –†–§ - —Ç—É—Ç –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã —Å–≤—è–∑–∏ —Å –Ω–∞—à–∏–º –≤–æ–ø—Ä–æ—Å–æ–º
> C—Ç–∞—Ç—å—è 1 - –µ—ë –æ–ø–∏—Å–∞–Ω–∏–µ, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å–µ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
...
> C—Ç–∞—Ç—å—è n - –µ—ë –æ–ø–∏—Å–∞–Ω–∏–µ, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å–µ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. K2-—ã–π –∫–æ–¥–µ–∫—Å –†–§ - —Ç—É—Ç –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã —Å–≤—è–∑–∏ —Å –Ω–∞—à–∏–º –≤–æ–ø—Ä–æ—Å–æ–º
> C—Ç–∞—Ç—å—è 1 - –µ—ë –æ–ø–∏—Å–∞–Ω–∏–µ, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å–µ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
...
> C—Ç–∞—Ç—å—è j - –µ—ë –æ–ø–∏—Å–∞–Ω–∏–µ, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å–µ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
...
m. Km-—ã–π –∫–æ–¥–µ–∫—Å –†–§ - —Ç—É—Ç –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã —Å–≤—è–∑–∏ —Å –Ω–∞—à–∏–º –≤–æ–ø—Ä–æ—Å–æ–º
> C—Ç–∞—Ç—å—è 1 - –µ—ë –æ–ø–∏—Å–∞–Ω–∏–µ, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å–µ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
...
> C—Ç–∞—Ç—å—è p - –µ—ë –æ–ø–∏—Å–∞–Ω–∏–µ, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å–µ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
### –í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã–µ)
1. –î–µ–π—Å—Ç–≤–∏–µ 1
2. –î–µ–π—Å—Ç–≤–∏–µ 2
3. –î–µ–π—Å—Ç–≤–∏–µ 3

–í –∫–æ–Ω—Ü–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–æ –î–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é –∏ –Ω–µ –ø—Ä–∏–∑—ã–≤–∞–µ—Ç –í–∞—Å –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö."""

        result = self.giga.chat({
            "messages": [
                {
                    "role": "assistant",
                    "content": prompt,
                    "attachments": [material_id],
                    
                }
            ],
            "temperature": 0.7,
            "max_tokens": 400
        })
        return result
    
